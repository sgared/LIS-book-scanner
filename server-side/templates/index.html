<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="A powerful OCR application for digitizing and cataloging library book collections with advanced metadata extraction and analytics." />
    <meta name="keywords" content="OCR, library, cataloging, books, digitization, metadata, scanner" />
    <meta name="author" content="LIS Book Scanner Project" />
    
    <!-- PWA Configuration -->
    <meta name="theme-color" content="#1a5f3f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Book Scanner" />
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />
    
    <!-- Favicons and Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icon-192x192.png') }}" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon-apple-touch.png') }}" />
    
    <title>LIS Book Scanner - Digital Cataloging Made Simple</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link
      href="{{ url_for('static', filename='style.css') }}"
      rel="stylesheet"
    />
  </head>

  <body class="bg-light">
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #1a5f3f 0%, #2d7a5a 100%);">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">
          <span style="font-size: 1.5rem;">üìö</span>
          LIS Book Scanner
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link active" href="/">
                <i class="fas fa-home"></i> Home
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/analytics">
                <i class="fas fa-chart-bar"></i> Analytics
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/database">
                <i class="fas fa-database"></i> Database
              </a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                <i class="fas fa-download"></i> Export
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/download/csv">
                  <i class="fas fa-file-csv"></i> CSV Format
                </a></li>
                <li><a class="dropdown-item" href="/download/json">
                  <i class="fas fa-file-code"></i> JSON Format
                </a></li>
              </ul>
            </li>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-5">
      <!-- Enhanced Header Section -->
      <div class="text-center mb-5">
        <div class="mb-4">
          <span style="font-size: 4rem; opacity: 0.8;">üìñ</span>
        </div>
        <h1 class="display-4 fw-bold text-primary mb-3">LIS Book Scanner</h1>
        <p class="lead text-secondary mb-4">Transform physical books into digital catalog records with AI-powered OCR</p>
        <div class="row justify-content-center">
      
        </div>
      </div>

      <!-- Enhanced Upload Form -->
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card border-0 shadow-lg" style="border-radius: 20px;">
            <div class="card-header bg-transparent border-0 pt-4">
              <div class="text-center">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #1a5f3f; opacity: 0.7;"></i>
                <h4 class="mt-3 mb-2" style="color: #1a5f3f;">Upload Book Images</h4>
                <p class="text-muted mb-0">Drag & drop or click to select images</p>
              </div>
            </div>
            <div class="card-body px-5 pb-5">
              <form
                id="uploadForm"
                action="{{ url_for('index') }}"
                method="POST"
                enctype="multipart/form-data"
              >
                <!-- Enhanced File Upload Area -->
                <div class="mb-4">
                  <div class="upload-area border-2 border-dashed rounded-3 p-4 text-center position-relative" 
                       style="border-color: #1a5f3f !important; background: rgba(26, 95, 63, 0.05); transition: all 0.3s ease;"
                       ondragover="event.preventDefault(); this.style.background='rgba(26, 95, 63, 0.1)'" 
                       ondragleave="this.style.background='rgba(26, 95, 63, 0.05)'"
                       onclick="document.getElementById('fileInput').click()">
                    
                    <input
                      type="file"
                      name="files"
                      multiple
                      accept="image/*"
                      class="form-control d-none"
                      id="fileInput"
                      required
                    />
                    
                    <!-- Mobile Camera Input (same name for compatibility) -->
                    <input
                      type="file"
                      name="files"
                      accept="image/*"
                      capture="environment"
                      class="d-none"
                      id="cameraInput"
                    />
                    
                    <div id="uploadPrompt">
                      <i class="fas fa-images" style="font-size: 2.5rem; color: #1a5f3f; opacity: 0.6;"></i>
                      <h5 class="mt-3 mb-2" style="color: #1a5f3f;">Choose Book Images</h5>
                      <p class="text-muted mb-3">Select multiple images or drag them here</p>
                      <div class="d-flex flex-column flex-md-row gap-2 justify-content-center">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('fileInput').click(); event.stopPropagation();">
                          <i class="fas fa-folder me-2"></i>Browse Files
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm d-md-none" onclick="document.getElementById('cameraInput').click(); event.stopPropagation();">
                          <i class="fas fa-camera me-2"></i>Take Photo
                        </button>
                      </div>
                    </div>
                    
                    <div id="filePreview" style="display: none;"></div>
                  </div>
                  
                  <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Supported formats: JPG, PNG, GIF ‚Ä¢ Max size: 10MB per file
                  </small>
                  
                  <!-- Mobile-specific help text -->
                  <small class="text-muted d-block mt-1 d-md-none">
                    <i class="fas fa-mobile-alt me-1"></i>
                    üì± Tap "Take Photo" to use your camera directly
                  </small>
                </div>

                <!-- Enhanced Tips Section -->
                <div class="card border-0 mb-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                  <div class="card-body">
                    <h6 class="card-title d-flex align-items-center" style="color: #1a5f3f;">
                      <i class="fas fa-lightbulb me-2"></i>
                      Pro Tips for Best Results
                    </h6>
                    <div class="row">
                      <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                          <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <small>Clear, well-lit photos</small>
                          </li>
                          <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <small>Include book cover & title page</small>
                          </li>
                        </ul>
                      </div>
                      <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                          <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <small>Copyright page for ISBN</small>
                          </li>
                          <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <small>Multiple books supported</small>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Enhanced Submit Button -->
                <div class="d-grid">
                  <button
                    type="submit"
                    class="btn btn-lg position-relative"
                    id="submitBtn"
                    style="background: linear-gradient(135deg, #1a5f3f 0%, #2d7a5a 100%); border: none; border-radius: 12px; color: white; padding: 15px;"
                  >
                    <span id="btnText">
                      <i class="fas fa-magic me-2"></i>
                      Start OCR Processing
                    </span>
                    <span id="btnLoading" style="display: none">
                      <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      Processing Images...
                    </span>
                  </button>
                </div>
                
                <!-- Progress Bar -->
                <div id="progressContainer" class="mt-3" style="display: none;">
                  <div class="progress" style="height: 8px; border-radius: 10px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         style="background: linear-gradient(90deg, #1a5f3f, #2d7a5a);"
                         role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <small class="text-muted d-block text-center mt-2">
                    <i class="fas fa-cog fa-spin me-1"></i>
                    Analyzing images with advanced OCR technology...
                  </small>
                </div>
                
                <p class="text-center text-muted mt-4 mb-0" style="font-size: 0.9rem;">
                  <i class="fas fa-shield-alt me-1"></i>
                  Powered by Tesseract OCR, spaCy NLP & Open Library API
                </p>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Features Section -->
      <div class="row g-4 mt-5" style="max-width: 900px; margin: 0 auto">
        <div class="col-12 col-md-4">
          <div class="text-center">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem">üìö</div>
            <h5
              style="color: #1a5f3f; font-size: 1.1rem; margin-bottom: 0.5rem"
            >
              Instant Recognition
            </h5>
            <p
              class="text-muted"
              style="font-size: 0.9rem; font-family: 'Segoe UI', sans-serif"
            >
              Advanced OCR extracts bibliographic data in seconds
            </p>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="text-center">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem">üåê</div>
            <h5
              style="color: #1a5f3f; font-size: 1.1rem; margin-bottom: 0.5rem"
            >
              API Enrichment
            </h5>
            <p
              class="text-muted"
              style="font-size: 0.9rem; font-family: 'Segoe UI', sans-serif"
            >
              Automatic enhancement with complete catalog records
            </p>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="text-center">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem">üíæ</div>
            <h5
              style="color: #1a5f3f; font-size: 1.1rem; margin-bottom: 0.5rem"
            >
              Export Ready
            </h5>
            <p
              class="text-muted"
              style="font-size: 0.9rem; font-family: 'Segoe UI', sans-serif"
            >
              Download results as CSV for your library system
            </p>
          </div>
        </div>
      </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Enhanced JavaScript Functionality -->
    <script>
      // Enhanced form submit with better UX
      document.querySelector('#uploadForm').addEventListener('submit', function (e) {
        console.log('üöÄ Form submission started');
        const btn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnLoading = document.getElementById('btnLoading');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');

        console.log('üìÅ Files selected:', fileInput.files.length);
        
        if (fileInput.files.length === 0) {
          e.preventDefault();
          console.log('‚ùå No files selected');
          showAlert('Please select at least one image to upload.', 'warning');
          return;
        }

        // Check file types and sizes
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        for (let file of fileInput.files) {
          console.log(`üìÑ Checking file: ${file.name}, type: ${file.type}, size: ${file.size}`);
          if (!validTypes.includes(file.type)) {
            e.preventDefault();
            console.log(`‚ùå Invalid file type: ${file.type}`);
            showAlert(`Invalid file type: ${file.name}. Please upload only image files.`, 'danger');
            return;
          }
          if (file.size > 10 * 1024 * 1024) { // 10MB limit
            e.preventDefault();
            console.log(`‚ùå File too large: ${file.size} bytes`);
            showAlert(`File too large: ${file.name}. Please use files under 10MB.`, 'danger');
            return;
          }
        }

        console.log('‚úÖ All files validated, proceeding with form submission');

        // Show loading state
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline-block';
        btn.disabled = true;
        if (progressContainer) {
          progressContainer.style.display = 'block';
          
          // Simulate progress
          let progress = 0;
          const progressBar = progressContainer.querySelector('.progress-bar');
          const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 85) progress = 85;
            if (progressBar) {
              progressBar.style.width = progress + '%';
              progressBar.setAttribute('aria-valuenow', progress);
            }
          }, 800);
        }
      });

      // Enhanced file input with preview and drag & drop
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.querySelector('.upload-area');
      
      if (fileInput && uploadArea) {
        const uploadPrompt = document.getElementById('uploadPrompt');
        const filePreview = document.getElementById('filePreview');

        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleFileDrop);

        function handleFileSelect(e) {
          const files = e.target.files;
          if (files.length > 0) {
            displayFilePreview(files);
          }
        }

        function handleDragOver(e) {
          e.preventDefault();
          uploadArea.style.background = 'rgba(26, 95, 63, 0.15)';
          uploadArea.style.borderColor = '#1a5f3f';
        }

        function handleDragLeave(e) {
          uploadArea.style.background = 'rgba(26, 95, 63, 0.05)';
        }

        function handleFileDrop(e) {
          e.preventDefault();
          uploadArea.style.background = 'rgba(26, 95, 63, 0.05)';
          
          const files = e.dataTransfer.files;
          fileInput.files = files;
          displayFilePreview(files);
        }

        function displayFilePreview(files) {
          const fileCount = files.length;
          if (uploadPrompt) uploadPrompt.style.display = 'none';
          if (filePreview) {
            filePreview.style.display = 'block';
            
            let previewHTML = `
              <div class="text-center">
                <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                <h6 class="mt-2 mb-3 text-success">Ready to Process</h6>
                <div class="d-flex flex-wrap gap-2 justify-content-center">`;
            
            for (let i = 0; i < Math.min(fileCount, 4); i++) {
              const file = files[i];
              previewHTML += `
                <div class="badge bg-light text-dark border d-flex align-items-center">
                  <i class="fas fa-image me-1"></i>
                  <span style="max-width: 100px; overflow: hidden; text-overflow: ellipsis;">
                    ${file.name}
                  </span>
                  <small class="ms-1 text-muted">(${(file.size / 1024 / 1024).toFixed(1)}MB)</small>
                </div>`;
            }
            
            if (fileCount > 4) {
              previewHTML += `<div class="badge bg-secondary">+${fileCount - 4} more</div>`;
            }
            
            previewHTML += `
                </div>
                <small class="text-muted d-block mt-2">
                  ${fileCount} file${fileCount > 1 ? 's' : ''} selected
                  <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearFiles()">
                    <i class="fas fa-times"></i> Clear
                  </button>
                </small>
              </div>`;
            
            filePreview.innerHTML = previewHTML;
          }
        }
      }

      // Global functions
      window.clearFiles = function() {
        if (fileInput) fileInput.value = '';
        if (cameraInput) cameraInput.value = '';
        const uploadPrompt = document.getElementById('uploadPrompt');
        const filePreview = document.getElementById('filePreview');
        if (uploadPrompt) uploadPrompt.style.display = 'block';
        if (filePreview) filePreview.style.display = 'none';
      }

      // Mobile camera input handling
      const cameraInput = document.getElementById('cameraInput');
      if (cameraInput) {
        cameraInput.addEventListener('change', function(e) {
          if (e.target.files && e.target.files.length > 0) {
            // Transfer camera files to main file input
            const dataTransfer = new DataTransfer();
            
            // Add existing files from file input
            if (fileInput.files) {
              for (let i = 0; i < fileInput.files.length; i++) {
                dataTransfer.items.add(fileInput.files[i]);
              }
            }
            
            // Add camera files
            for (let i = 0; i < e.target.files.length; i++) {
              dataTransfer.items.add(e.target.files[i]);
            }
            
            // Update main file input
            fileInput.files = dataTransfer.files;
            
            // Update preview
            updateFilePreview();
            
            // Show success message
            showAlert(`üì∏ ${e.target.files.length} photo${e.target.files.length > 1 ? 's' : ''} captured successfully!`, 'success');
          }
        });
      }

      function showAlert(message, type) {
        const alertHTML = `
          <div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
            <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>`;
        
        const container = document.querySelector('.container');
        if (container) {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = alertHTML;
          container.insertBefore(tempDiv.firstElementChild, container.firstElementChild);
          
          // Auto-dismiss after 5 seconds
          setTimeout(() => {
            const alert = document.querySelector('.alert');
            if (alert && window.bootstrap) {
              const bsAlert = new bootstrap.Alert(alert);
              bsAlert.close();
            }
          }, 5000);
        }
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        // Add active state for current page
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
          const linkPath = new URL(link.href).pathname;
          if (linkPath === currentPath || (currentPath === '/' && linkPath === '/')) {
            link.classList.add('active');
          }
        });
      });
    </script>
  </body>
</html>
